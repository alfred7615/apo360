root@srv1170282:/var/www/apo360.net#
root@srv1170282:/var/www/apo360.net# rm -f /var/www/apo360.net/server.js
root@srv1170282:/var/www/apo360.net# git pull origin main
From https://github.com/alfred7615/apo360
 * branch            main       -> FETCH_HEAD
Already up to date.
root@srv1170282:/var/www/apo360.net# npm ci
npm warn deprecated @esbuild-kit/esm-loader@2.6.5: Merged into tsx: https://tsx.is
npm warn deprecated @esbuild-kit/core-utils@3.3.2: Merged into tsx: https://tsx.is

added 537 packages, and audited 538 packages in 13s

70 packages are looking for funding
  run `npm fund` for details

9 vulnerabilities (3 low, 5 moderate, 1 high)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
root@srv1170282:/var/www/apo360.net# npm run build

> rest-express@1.0.0 build
> vite build && esbuild server/index-prod.ts --platform=node --packages=external --bundle --format=esm --outfile=dist/index.js

vite v5.4.20 building for production...
transforming (19) ../node_modules/wouter/esm/use-browser-location.js
A PostCSS plugin did not pass the `from` option to `postcss.parse`. This may cause imported assets to be incorrectly transformed. If you've recently added a PostCSS plugin that raised this warning, please contact the package author to fix the issue.
âœ“ 2790 modules transformed.
../dist/public/index.html                     1.53 kB â”‚ gzip:   0.66 kB
../dist/public/assets/index-CpuEqJzU.css    144.64 kB â”‚ gzip:  26.94 kB
../dist/public/assets/index-D0Tej4IN.js   1,436.20 kB â”‚ gzip: 362.38 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
âœ“ built in 15.11s
â–² [WARNING] Duplicate member "updateServicio" in class body [duplicate-class-member]

    server/storage.ts:1859:8:
      1859 â”‚   async updateServicio(id: string, data: any): Promise<any> {
           â•µ         ~~~~~~~~~~~~~~

  The original member "updateServicio" is here:

    server/storage.ts:808:8:
      808 â”‚   async updateServicio(id: string, data: Partial<InsertServicio>): Promise<Servicio | undefined> {
          â•µ         ~~~~~~~~~~~~~~

â–² [WARNING] Duplicate member "getFavoritosUsuario" in class body [duplicate-class-member]

    server/storage.ts:2424:8:
      2424 â”‚   async getFavoritosUsuario(usuarioId: string, tipo?: string): Promise<any[]> {
           â•µ         ~~~~~~~~~~~~~~~~~~~

  The original member "getFavoritosUsuario" is here:

    server/storage.ts:776:8:
      776 â”‚   async getFavoritosUsuario(usuarioId: string): Promise<any[]> {
          â•µ         ~~~~~~~~~~~~~~~~~~~

â–² [WARNING] Duplicate member "getInteraccionesUsuario" in class body [duplicate-class-member]

    server/storage.ts:2607:8:
      2607 â”‚   async getInteraccionesUsuario(
           â•µ         ~~~~~~~~~~~~~~~~~~~~~~~

  The original member "getInteraccionesUsuario" is here:

    server/storage.ts:552:8:
      552 â”‚   async getInteraccionesUsuario(publicidadId: string, usuarioId: string): Promise<{ hasLike: boolean; has...
          â•µ         ~~~~~~~~~~~~~~~~~~~~~~~

âœ˜ [ERROR] No matching export in "server/routes.ts" for import "default"

    server/index-prod.ts:12:7:
      12 â”‚ import apiRoutes from './routes.js';
         â•µ        ~~~~~~~~~

â–² [WARNING] Duplicate member "getComentarios" in class body [duplicate-class-member]

    server/storage.ts:2631:8:
      2631 â”‚   async getComentarios(tipoContenido: string, contenidoId: string): Promise<Comentario[]> {
           â•µ         ~~~~~~~~~~~~~~

  The original member "getComentarios" is here:

    server/storage.ts:1828:8:
      1828 â”‚   async getComentarios(tipoContenido: string, contenidoId: string): Promise<Comentario[]> {
           â•µ         ~~~~~~~~~~~~~~

â–² [WARNING] Duplicate member "createComentario" in class body [duplicate-class-member]

    server/storage.ts:2647:8:
      2647 â”‚   async createComentario(data: InsertComentario): Promise<Comentario> {
           â•µ         ~~~~~~~~~~~~~~~~

  The original member "createComentario" is here:

    server/storage.ts:1841:8:
      1841 â”‚   async createComentario(data: InsertComentario): Promise<Comentario> {
           â•µ         ~~~~~~~~~~~~~~~~

5 of 7 warnings and 1 error shown (disable the message limit with --log-limit=0)
root@srv1170282:/var/www/apo360.net#
root@srv1170282:/var/www/apo360.net#
root@srv1170282:/var/www/apo360.net#
root@srv1170282:/var/www/apo360.net#
root@srv1170282:/var/www/apo360.net# npm run db:push

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/var/www/apo360.net/drizzle.config.ts'
Using 'pg' driver for database querying
[â£·] Pulling schema from database...
error: password authentication failed for user "apo360_admin"
    at /var/www/apo360.net/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async Object.query (/var/www/apo360.net/node_modules/drizzle-kit/bin.cjs:80601:26)
    at async fromDatabase2 (/var/www/apo360.net/node_modules/drizzle-kit/bin.cjs:19253:25) {
  length: 108,
  severity: 'FATAL',
  code: '28P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'auth.c',
  line: '331',
  routine: 'auth_failed'
}
root@srv1170282:/var/www/apo360.net# pm2 restart apo360 --update-env
[PM2] Applying action restartProcessId on app [apo360](ids: [ 0 ])
[PM2] [apo360](0) âœ“
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name               â”‚ mode     â”‚ â†º    â”‚ status    â”‚ cpu      â”‚ memory   â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ apo360             â”‚ fork     â”‚ 4    â”‚ online    â”‚ 0%       â”‚ 26.5mb   â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
root@srv1170282:/var/www/apo360.net# pm2 logs apo360 --lines 30
[TAILING] Tailing last 30 lines for [apo360] process (change the value with --lines option)
/root/.pm2/logs/apo360-out.log last 30 lines:
0|apo360   | âœ… Login exitoso: aapomayta15@gmail.com
0|apo360   | ğŸ” Login attempt: aapomayta15@gmail.com
0|apo360   | âœ… Login exitoso: aapomayta15@gmail.com
0|apo360   | ==============================================
0|apo360   | ğŸš€ APO360 COMPATIBILITY SERVER
0|apo360   | ğŸ“ Puerto: 5000
0|apo360   | ğŸ” AutenticaciÃ³n: ACEPTA CUALQUIER TOKEN
0|apo360   | ğŸ¯ Objetivo: Hacer que el frontend funcione
0|apo360   | ğŸ”‘ Credenciales: aapomayta15@gmail.com / Admin123!
0|apo360   | ğŸŒ Frontend: http://localhost:5000/
0|apo360   | ==============================================
0|apo360   |
0|apo360   | ğŸ’¡ INSTRUCCIONES PARA PROBAR:
0|apo360   | 1. Login devuelve 4 tipos de token
0|apo360   | 2. /api/auth/user acepta CUALQUIER token que empiece con "Bearer"
0|apo360   | 3. /api/users/me funciona incluso SIN token
0|apo360   | ğŸ” Login: aapomayta15@gmail.com
0|apo360   | âœ… Login exitoso. Tokens generados: jwt, simple, random, legacy
0|apo360   | âœ… Token aceptado: eyJhbGciOiJIUzI1NiIs...
0|apo360   | âš ï¸  Sin token, usando usuario por defecto
0|apo360   | âœ… Token aceptado: token-inventado-1234...
0|apo360   | ğŸ” Login: aapomayta15@gmail.com
0|apo360   | âœ… Login exitoso. Tokens generados: jwt, simple, random, legacy
0|apo360   | ğŸ” Login: aapomayta15@gmail.com
0|apo360   | âœ… Login exitoso. Tokens generados: jwt, simple, random, legacy
0|apo360   | âœ… Token aceptado: eyJhbGciOiJIUzI1NiIs...
0|apo360   | ğŸ” Login: aapomayta15@gmail.com
0|apo360   | âœ… Login exitoso. Tokens generados: jwt, simple, random, legacy
0|apo360   | ğŸ” Login: aapomayta15@gmail.com
0|apo360   | âœ… Login exitoso. Tokens generados: jwt, simple, random, legacy

/root/.pm2/logs/apo360-error.log last 30 lines:
0|apo360   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|apo360   | ReferenceError: require is not defined in ES module scope, you can use import instead
0|apo360   | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/apo360.net/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|apo360   |     at file:///var/www/apo360.net/server.js:1:12
0|apo360   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|apo360   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|apo360   | ReferenceError: require is not defined in ES module scope, you can use import instead
0|apo360   | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/apo360.net/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|apo360   |     at file:///var/www/apo360.net/server.js:1:12
0|apo360   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|apo360   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|apo360   | ReferenceError: require is not defined in ES module scope, you can use import instead
0|apo360   | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/apo360.net/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|apo360   |     at file:///var/www/apo360.net/server.js:1:12
0|apo360   |     at ModuleJob.run (node:internal/modules/esm/module_job:325:25)
0|apo360   |     at async ModuleLoader.import (node:internal/modules/esm/loader:606:24)
0|apo360   | Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/var/www/apo360.net/server.js' imported from /usr/lib/node_modules/pm2/lib/ProcessContainerFork.js
0|apo360   |     at finalizeResolution (node:internal/modules/esm/resolve:283:11)
0|apo360   |     at moduleResolve (node:internal/modules/esm/resolve:952:10)
0|apo360   |     at defaultResolve (node:internal/modules/esm/resolve:1188:11)
0|apo360   |     at ModuleLoader.defaultResolve (node:internal/modules/esm/loader:708:12)
0|apo360   |     at #cachedDefaultResolve (node:internal/modules/esm/loader:657:25)
0|apo360   |     at ModuleLoader.resolve (node:internal/modules/esm/loader:640:38)
0|apo360   |     at ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:264:38)
0|apo360   |     at ModuleLoader.import (node:internal/modules/esm/loader:605:34)
0|apo360   |     at defaultImportModuleDynamicallyForScript (node:internal/modules/esm/utils:234:31)
0|apo360   |     at importModuleDynamicallyCallback (node:internal/modules/esm/utils:256:12) {
0|apo360   |   code: 'ERR_MODULE_NOT_FOUND',
0|apo360   |   url: 'file:///var/www/apo360.net/server.js'
0|apo360   | }
