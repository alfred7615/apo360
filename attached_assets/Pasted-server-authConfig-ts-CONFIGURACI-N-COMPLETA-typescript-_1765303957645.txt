server/authConfig.ts - CONFIGURACI√ìN COMPLETA:
typescript
import { Express } from "express";
import session from "express-session";
import passport from "passport";
import { Strategy as GoogleStrategy } from "passport-google-oauth20";
import { Storage } from "./storage";

// Funci√≥n auxiliar
const isValidString = (str: any): str is string => {
  return typeof str === "string" && str.trim().length > 0;
};

// Detectar entorno
const hasReplitEnv = isValidString(process.env.REPL_ID);
const hasGoogleEnv = isValidString(process.env.GOOGLE_CLIENT_ID) && 
                     isValidString(process.env.GOOGLE_CLIENT_SECRET);

// Determinar modo de autenticaci√≥n
const explicitMode = process.env.AUTH_MODE?.trim().toLowerCase();
const authMode = explicitMode || 
                (hasReplitEnv ? "replit" : 
                 hasGoogleEnv ? "google" : "none");

console.log(`üîê Modo de autenticaci√≥n: ${authMode}`);

// Configuraci√≥n de Google OAuth
const googleConfig = hasGoogleEnv ? {
  clientID: process.env.GOOGLE_CLIENT_ID!,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  callbackURL: process.env.GOOGLE_CALLBACK_URL || 
               `${process.env.PUBLIC_URL || 'http://localhost:5000'}/api/auth/google/callback`,
  scope: ['profile', 'email', 'https://www.googleapis.com/auth/contacts.readonly']
} : null;

// Configuraci√≥n de sesi√≥n
const sessionConfig = {
  secret: process.env.SESSION_SECRET || 'default-secret-change-in-production',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    maxAge: 24 * 60 * 60 * 1000 // 24 horas
  }
};

export async function setupAuth(app: Express, storage: Storage) {
  // Configurar sesiones
  app.use(session(sessionConfig));
  app.use(passport.initialize());
  app.use(passport.session());

  // Serializaci√≥n de usuario
  passport.serializeUser((user: any, done) => {
    done(null, user.id);
  });

  passport.deserializeUser(async (id: string, done) => {
    try {
      const user = await storage.getUser(id);
      done(null, user || null);
    } catch (error) {
      done(error, null);
    }
  });

  // Configurar estrategias seg√∫n el modo
  if (authMode === 'google' && googleConfig) {
    setupGoogleAuth(app, storage, googleConfig);
  } else if (authMode === 'replit') {
    console.log('‚úÖ Replit Auth configurado (modo autom√°tico)');
    // Replit OAuth ya est√° integrado en el framework
  } else {
    console.log('‚ö†Ô∏è  Modo de autenticaci√≥n: none - Sin autenticaci√≥n');
  }

  // Rutas de autenticaci√≥n
  setupAuthRoutes(app);
}

function setupGoogleAuth(app: Express, storage: Storage, config: any) {
  passport.use(new GoogleStrategy({
    clientID: config.clientID,
    clientSecret: config.clientSecret,
    callbackURL: config.callbackURL,
    scope: config.scope
  }, async (accessToken, refreshToken, profile, done) => {
    try {
      console.log('üì• Perfil de Google recibido:', profile.id);
      
      // Buscar o crear usuario
      let user = await storage.getUserByEmail(profile.emails?.[0]?.value || '');
      
      if (!user) {
        // Crear nuevo usuario
        user = await storage.createUser({
          id: `google-${profile.id}`,
          email: profile.emails?.[0]?.value || '',
          firstName: profile.name?.givenName || '',
          lastName: profile.name?.familyName || '',
          profileImageUrl: profile.photos?.[0]?.value,
          googleId: profile.id,
          googleAccessToken: accessToken,
          googleRefreshToken: refreshToken
        });
        console.log('‚úÖ Nuevo usuario creado:', user.email);
      } else {
        // Actualizar token existente
        await storage.updateUser(user.id, {
          googleAccessToken: accessToken,
          googleRefreshToken: refreshToken,
          ultimaConexion: new Date()
        });
        console.log('‚úÖ Usuario existente actualizado:', user.email);
      }
      
      done(null, user);
    } catch (error) {
      console.error('‚ùå Error en Google OAuth:', error);
      done(error, null);
    }
  }));

  console.log('‚úÖ Google OAuth configurado');
}

function setupAuthRoutes(app: Express) {
  // Ruta para iniciar login con Google
  app.get('/api/auth/google', passport.authenticate('google'));

  // Callback de Google
  app.get('/api/auth/google/callback',
    passport.authenticate('google', { failureRedirect: '/login' }),
    (req, res) => {
      // Redirigir al frontend
      res.redirect('/');
    }
  );

  // Obtener configuraci√≥n de autenticaci√≥n
  app.get('/api/auth/config', (req, res) => {
    const config = {
      mode: authMode,
      googleClientId: process.env.GOOGLE_CLIENT_ID || '',
      replitClientId: process.env.REPL_ID || '',
      googleAuthUrl: authMode === 'google' ? 
        `/api/auth/google` : null,
      replitAuthUrl: authMode === 'replit' ? 
        `/api/auth/replit` : null,
      timestamp: new Date().toISOString()
    };
    res.json(config);
  });

  // Obtener usuario actual
  app.get('/api/auth/user', (req, res) => {
    if (req.isAuthenticated()) {
      res.json(req.user);
    } else {
      res.status(401).json({ message: 'No autenticado' });
    }
  });

  // Logout
  app.get('/api/auth/logout', (req, res) => {
    req.logout((err) => {
      if (err) {
        return res.status(500).json({ error: 'Error al cerrar sesi√≥n' });
      }
      res.json({ message: 'Sesi√≥n cerrada' });
    });
  });

  // Importar contactos de Google
  app.get('/api/auth/google/contacts', async (req, res) => {
    try {
      if (!req.isAuthenticated()) {
        return res.status(401).json({ message: 'No autenticado' });
      }

      const user = req.user as any;
      if (!user.googleAccessToken) {
        return res.status(400).json({ message: 'No tiene acceso a Google' });
      }

      // Importar contactos usando el token
      const contacts = await importGoogleContacts(user.googleAccessToken);
      
      // Guardar contactos en la base de datos
      await saveContactsToDatabase(user.id, contacts);
      
      res.json({
        success: true,
        count: contacts.length,
        contacts: contacts.slice(0, 10) // Devolver primeros 10
      });
    } catch (error) {
      console.error('‚ùå Error importando contactos:', error);
      res.status(500).json({ error: 'Error importando contactos' });
    }
  });
}

// Funci√≥n para importar contactos de Google
async function importGoogleContacts(accessToken: string) {
  try {
    const response = await fetch('https://people.googleapis.com/v1/people/me/connections', {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Accept': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`Google API error: ${response.statusText}`);
    }

    const data = await response.json();
    const contacts = data.connections || [];

    // Procesar contactos
    return contacts.map((contact: any) => ({
      id: contact.resourceName,
      name: contact.names?.[0]?.displayName || 'Sin nombre',
      email: contact.emailAddresses?.[0]?.value || '',
      phone: contact.phoneNumbers?.[0]?.value || '',
      photo: contact.photos?.[0]?.url || ''
    })).filter((c: any) => c.email || c.phone); // Solo contactos con email o tel√©fono

  } catch (error) {
    console.error('Error fetching Google contacts:', error);
    return [];
  }
}

// Funci√≥n para guardar contactos en la base de datos
async function saveContactsToDatabase(userId: string, contacts: any[]) {
  // Implementar seg√∫n tu modelo de datos
  console.log(`Guardando ${contacts.length} contactos para usuario ${userId}`);
  // Aqu√≠ ir√≠a tu l√≥gica para guardar en tu base de datos
}

export { authMode };
export const isAuthenticated = (req: any, res: any, next: any) => {
  if (req.isAuthenticated()) {
    return next();
  }
  res.status(401).json({ message: 'No autenticado' });
};
2. server/routes.ts - AGREGAR RUTAS DE CONTACTOS:
typescript
// Agregar estas rutas en tu archivo routes.ts

// ============================================================
// CONTACTOS DE GOOGLE
// ============================================================

// Obtener contactos del usuario
app.get('/api/contactos', isAuthenticated, async (req: any, res) => {
  try {
    const userId = req.user.claims?.sub || req.user.id;
    const contactos = await storage.getContactosUsuario(userId);
    res.json(contactos);
  } catch (error) {
    console.error('Error obteniendo contactos:', error);
    res.status(500).json({ message: 'Error obteniendo contactos' });
  }
});

// Importar contactos desde Google
app.post('/api/contactos/importar-google', isAuthenticated, async (req: any, res) => {
  try {
    const userId = req.user.claims?.sub || req.user.id;
    const user = await storage.getUser(userId);
    
    if (!user.googleAccessToken) {
      return res.status(400).json({ 
        message: 'No tiene acceso a Google. Por favor, inicie sesi√≥n con Google primero.' 
      });
    }

    // Importar contactos usando el nuevo endpoint
    const importResponse = await fetch(`http://localhost:${process.env.PORT || 5000}/api/auth/google/contacts`, {
      headers: {
        'Cookie': req.headers.cookie // Pasar la sesi√≥n
      }
    });

    if (!importResponse.ok) {
      throw new Error('Error importando contactos');
    }

    const result = await importResponse.json();
    res.json(result);
  } catch (error) {
    console.error('Error importando contactos:', error);
    res.status(500).json({ message: 'Error importando contactos' });
  }
});

// Agregar contacto manualmente
app.post('/api/contactos', isAuthenticated, async (req: any, res) => {
  try {
    const userId = req.user.claims?.sub || req.user.id;
    const contacto = await storage.crearContacto({
      ...req.body,
      usuarioId: userId
    });
    res.json(contacto);
  } catch (error) {
    console.error('Error creando contacto:', error);
    res.status(500).json({ message: 'Error creando contacto' });
  }
});
3. server/storage.ts - AGREGAR M√âTODOS PARA CONTACTOS:
typescript
// Agregar estos m√©todos a tu clase Storage

export class Storage {
  // ... m√©todos existentes ...

  // Obtener contactos de un usuario
  async getContactosUsuario(usuarioId: string): Promise<any[]> {
    const result = await this.db.select().from(contactos).where(
      eq(contactos.usuarioId, usuarioId)
    );
    return result;
  }

  // Crear contacto
  async crearContacto(data: any): Promise<any> {
    const [contacto] = await this.db.insert(contactos).values(data).returning();
    return contacto;
  }

  // Obtener usuario por email
  async getUserByEmail(email: string): Promise<any> {
    const [user] = await this.db.select().from(usuarios).where(
      eq(usuarios.email, email)
    ).limit(1);
    return user;
  }

  // Buscar usuario por Google ID
  async getUserByGoogleId(googleId: string): Promise<any> {
    const [user] = await this.db.select().from(usuarios).where(
      eq(usuarios.googleId, googleId)
    ).limit(1);
    return user;
  }

  // Actualizar tokens de Google
  async updateGoogleTokens(userId: string, tokens: {
    googleAccessToken?: string;
    googleRefreshToken?: string;
  }): Promise<void> {
    await this.db.update(usuarios)
      .set(tokens)
      .where(eq(usuarios.id, userId));
  }
}
4. shared/schema.ts - AGREGAR ESQUEMA DE CONTACTOS:
typescript
// Agregar esta tabla al final del archivo

export const contactos = pgTable("contactos", {
  id: text("id").primaryKey().default(sql`gen_random_uuid()`),
  usuarioId: text("usuario_id").notNull().references(() => usuarios.id, { onDelete: "cascade" }),
  nombre: text("nombre"),
  email: text("email"),
  telefono: text("telefono"),
  tipo: text("tipo").default("personal"), // personal, familiar, emergencia
  relacion: text("relacion"),
  googleContactId: text("google_contact_id"),
  fotoUrl: text("foto_url"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});

export type Contacto = typeof contactos.$inferSelect;
export type InsertContacto = typeof contactos.$inferInsert;
5. client/src/components/GoogleContactsImport.tsx - COMPONENTE REACT:
tsx
import React, { useState } from 'react';
import { Button } from './ui/button';
import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
import { Loader2, Users, Check } from 'lucide-react';

export function GoogleContactsImport() {
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [contacts, setContacts] = useState<any[]>([]);
  const [error, setError] = useState<string | null>(null);

  const importContacts = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await fetch('/api/contactos/importar-google', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Error importando contactos');
      }

      const data = await response.json();
      setContacts(data.contacts || []);
      setSuccess(true);
      
      // Actualizar lista de contactos despu√©s de 3 segundos
      setTimeout(() => {
        window.location.reload();
      }, 3000);
    } catch (err) {
      setError(err.message || 'Error desconocido');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Card className="w-full max-w-md mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Users className="h-5 w-5" />
          Importar Contactos de Google
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <p className="text-sm text-gray-600">
          Importa tus contactos de Google autom√°ticamente para agregarlos como contactos de emergencia.
        </p>
        
        {error && (
          <div className="p-3 bg-red-50 border border-red-200 rounded-md">
            <p className="text-sm text-red-600">{error}</p>
          </div>
        )}
        
        {success ? (
          <div className="p-3 bg-green-50 border border-green-200 rounded-md">
            <div className="flex items-center gap-2">
              <Check className="h-5 w-5 text-green-600" />
              <p className="text-sm text-green-700">
                ¬°Contactos importados exitosamente! Se agregaron {contacts.length} contactos.
              </p>
            </div>
            {contacts.length > 0 && (
              <div className="mt-3">
                <h4 className="font-medium text-sm mb-2">Contactos importados:</h4>
                <ul className="space-y-1 max-h-40 overflow-y-auto">
                  {contacts.map((contact, index) => (
                    <li key={index} className="text-sm p-2 bg-white rounded border">
                      <div className="font-medium">{contact.name}</div>
                      {contact.email && <div className="text-gray-600">{contact.email}</div>}
                      {contact.phone && <div className="text-gray-600">{contact.phone}</div>}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        ) : (
          <Button
            onClick={importContacts}
            disabled={loading}
            className="w-full"
          >
            {loading ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Importando...
              </>
            ) : (
              <>
                <Users className="mr-2 h-4 w-4" />
                Importar Contactos de Google
              </>
            )}
          </Button>
        )}
        
        <div className="text-xs text-gray-500">
          <p>Nota: Solo se importar√°n contactos con email o tel√©fono.</p>
          <p>Necesitas haber iniciado sesi√≥n con Google para usar esta funci√≥n.</p>
        </div>
      </CardContent>
    </Card>
  );
}
6. client/src/pages/perfil.tsx - INTEGRAR COMPONENTE:
tsx
// En tu p√°gina de perfil, agregar:
import { GoogleContactsImport } from '../components/GoogleContactsImport';

// Dentro del return, en una secci√≥n apropiada:
<div className="space-y-6">
  <h2 className="text-2xl font-bold">Contactos de Emergencia</h2>
  
  <GoogleContactsImport />
  
  {/* Lista de contactos existentes */}
  <div className="grid gap-4">
    {/* Aqu√≠ tu lista de contactos */}
  </div>
</div>
‚öôÔ∏è CONFIGURACI√ìN EN REPLIT:
1. Variables de entorno en Replit (Secrets):
text
GOOGLE_CLIENT_ID=16943049442-mbv8ll4g7iu186nttlahsdhh8of1jq1u.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
GOOGLE_CALLBACK_URL=https://TU-REPL.replit.app/api/auth/google/callback
AUTH_MODE=google
SESSION_SECRET=tu-session-secret-aqui
DATABASE_URL=tu-neon-db-url
2. En Google Cloud Console:
Ir a APIs & Services ‚Üí Credentials

Editar tu OAuth 2.0 Client ID

Agregar a Authorized redirect URIs:

text
https://TU-REPL.replit.app/api/auth/google/callback
https://apo360.net/api/auth/google/callback
Ir a APIs & Services ‚Üí Library

Buscar y habilitar: People API

3. Script de build para Replit:
json
{
  "scripts": {
    "dev": "concurrently \"tsx watch server/index-dev.ts\" \"vite\"",
    "build": "vite build && esbuild server/index-prod.ts --platform=node --packages=external --bundle --format=esm --outfile=dist/index.js",
    "start": "node dist/index.js"
  }
}